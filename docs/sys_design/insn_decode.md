# 指令解码

## 设计理念

k/uprobes在插桩时

- 对于指令的插桩需要考虑指令的合法性判断
- 在函数跟踪时需要解析出栈帧变化的大小

## 设计思路

### 指令合法性判断

根据Linux里Kprobes关于Riscv指令的合法性检验，设置指令黑名单，黑名单内的指令不允许跟踪.

- system相关指令
- 页表刷新相关指令
- 常规指令
  - auipc
  - branch
  - jal
  - jalr
- 压缩指令
  - c_j
  - c_jr
  - c_jal
  - c_jalr
  - c_beqz
  - c_bnez
  - c_ebreak

### sp相关指令解码

根据Riscv文档，操作sp相关的指令有

- addi

  ```
  31               20 19       1514     12 11     7 6         0
  ┌──────────────────┬──────────┬─────────┬────────┬─────────┐
  │    imm[11:0]     │    rs1   │   000   │   rd   │ 0010011 │
  └──────────────────┴──────────┴─────────┴────────┴─────────┘
  ```

- c.addi

  ```
  15    13 12    11 10        7 6               2 1        0
  ┌───────┬────────┬───────────┬─────────────────┬─────────┐
  │  011  │ imm[5] │    rd     │    imm[4:0]     │    01   │
  └───────┴────────┴───────────┴─────────────────┴─────────┘
  ```

- c.addi16sp

  ```
  15    13 12    11 10        7 6                  2 1        0
  ┌───────┬────────┬───────────┬────────────────────┬─────────┐
  │  011  │ imm[9] │   00010   │   imm[4|6|8:7|5]   │    01   │
  └───────┴────────┴───────────┴────────────────────┴─────────┘
  ```

- c.addi4spn

  ```
  15    13 12                 5 4       2 1        0
  ┌───────┬────────────────────┬─────────┬─────────┐
  │  000  │  imm[5:4|9:6|2|3]  │   rd'   │    00   │
  └───────┴────────────────────┴─────────┴─────────┘
  ```

  